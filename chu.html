<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Only My Baby</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <style>
        textarea {
            height: 60px;
            width: 80%;
        }

        .dkArea, .chuArea {
            width: 50%;
            height: 300px;
            overflow: auto;
            border-radius: 20px;
            padding: 10px;
        }

        .dkArea {
            background-image: linear-gradient(0deg, transparent, rgb(131, 216, 250));
        }

        .chuArea {
            background-image: linear-gradient(0deg, transparent, rgb(251, 149, 255));
        }

        .Area {
            display: flex;
            width: 100%;
            position: relative;
        }

        ul {
            padding: 0;
        }

        ul li {
            list-style-type: none;
            margin-left: -20px;
            padding-right: 5px;
            font-size: small;
            font-style: italic;
        }

        ul li:nth-child(2n) {
            font-style: normal;
            font-size: medium;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .block {
            position: absolute;
            width: 100%;
            height: 110%;
            top: 0;
            left: 0;
            background-image: linear-gradient(180deg, transparent, rgb(255, 255, 255));
            z-index: 500;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <h1 class="LoveDate" style="color: rgb(255, 198, 208)"></h1>
    <textarea placeholder="寫下你想對寶貝說的話..."></textarea>
    <button onclick="submitLetter()">送出</button>
    <div class="Area">
        <div class="block"></div>
        <ul class="dkArea"></ul>
        <ul class="chuArea"></ul>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwv910KyAYwIKV9SqpUW8GKu0AmFPwDIg1hpJ-OKEe4Q81KPFmDjr3Rumvy2MVT9GQ8/exec";

        window.onload = function () {
            renderLoveDay();
            fetchData();
        };

        function renderLoveDay() {
            const today = new Date();
            const startDate = new Date("2021-11-14");
            const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
            document.querySelector(".LoveDate").textContent = `Love you ${diffDays}th Day`;
        }

        function submitLetter() {
            const letter = document.querySelector("textarea").value.trim();
            if (!letter) {
                alert("請先輸入內容");
                return;
            }

            $.ajax({
                url: API_URL,
                type: "POST",
                data: {
                    mission: "WriteLetter",
                    letter: letter
                },
                dataType: "text",
                success: function (res) {
                    alert("送出成功！");
                    fetchData(); // 更新內容
                    document.querySelector("textarea").value = ""; // 清空輸入框
                },
                error: function (err) {
                    alert("送出失敗，請稍後再試。");
                    console.error(err);
                }
            });
        }

        function fetchData() {
            $.ajax({
                url: API_URL,
                type: "POST",
                data: {
                    mission: "GetAllInfo"
                },
                dataType: "text",
                success: function (res) {
                    try {
                        const data = JSON.parse(res);
                        renderMessages(data);
                    } catch (err) {
                        console.error("JSON parse error:", err);
                        alert("資料讀取錯誤");
                    }
                },
                error: function (err) {
                    console.error(err);
                    alert("無法取得資料");
                }
            });
        }

        function renderMessages(data) {
            const dkArea = document.querySelector('.dkArea');
            const chuArea = document.querySelector('.chuArea');
            dkArea.innerHTML = '';
            chuArea.innerHTML = '';

            const dkFrag = document.createDocumentFragment();
            const chuFrag = document.createDocumentFragment();

            data.forEach(row => {
                // row = [col1, col2, col3, col4, col5]
                if (row[0]) {
                    const li = document.createElement('li');
                    li.textContent = row[0];
                    dkFrag.appendChild(li);
                }
                if (row[1]) {
                    const li = document.createElement('li');
                    li.textContent = `[${row[1]}]`;
                    dkFrag.appendChild(li);
                }
                if (row[2]) {
                    const li = document.createElement('li');
                    li.textContent = row[2];
                    chuFrag.appendChild(li);
                }
                if (row[3]) {
                    const li = document.createElement('li');
                    li.textContent = `[${row[3]}]`;
                    chuFrag.appendChild(li);
                }
            });

            dkArea.appendChild(dkFrag);
            chuArea.appendChild(chuFrag);
        }
    </script>
</body>

</html>
